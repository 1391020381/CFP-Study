# 市盈率(PE)图表制作指南

## 一、核心公式

```
TTM市盈率(动态市盈率) = 股价 ÷ TTM_EPS
TTM_EPS = 最近4个单季度EPS之和
```

---

## 二、EPS数据陷阱与处理

### 问题：季度财报中的EPS是累计数据

| 季度 | 累计EPS含义 | 单季度EPS计算 |
|------|-------------|---------------|
| Q1(03月) | 第一季度累计 | Q1单季 = Q1累计 |
| Q2(06月) | 上半年累计 | Q2单季 = Q2累计 - Q1累计 |
| Q3(09月) | 前三季度累计 | Q3单季 = Q3累计 - Q2累计 |
| Q4(12月) | 全年累计 | Q4单季 = Q4累计 - Q3累计 |

### 跨年度注意事项

- Q1累计是独立的新一年数据，**不能用diff计算**
- 必须按季度识别，分别处理
- 例如：2024-Q4累计5.93 → 2025-Q1累计1.48，diff = -4.45 ❌

---

## 三、摊薄 vs 加权每股收益

| 类型 | 公式 | 使用场景 |
|------|------|----------|
| 摊薄EPS | 净利润 ÷ 期末总股本 | **同花顺等平台使用** ✅ |
| 加权EPS | 净利润 ÷ 加权平均股本 | 考虑股本变化期间 |

**差异：** 约5-10%，摊薄EPS通常更小，计算出的PE更大

---

## 四、三种市盈率类型

```
静态市盈率 = 股价 ÷ 上一年度EPS
动态市盈率/TTM = 股价 ÷ 最近4个季度EPS之和  ⭐ 最常用
预期市盈率 = 股价 ÷ 预测未来EPS
```

**为什么用TTM？**
- 静态PE数据滞后（年报延迟发布）
- TTM PE数据及时、准确
- 消除季节性因素影响

---

## 五、估值区间计算方法

### 方法1：标准差法
```
均值 = μ
低估值线 = μ - 1σ
高估值线 = μ + 1σ
```

### 方法2：分位数法
```
低估值线 = P10 或 P25
中位数 = P50
高估值线 = P75 或 P90
```

### 方法3：极值法
```
低估值线 = 历史最低值
高估值线 = 历史最高值
```

---

## 六、常见误区

| 误区 | 正确理解 |
|------|----------|
| 直接用单季度EPS计算PE | 必须用TTM EPS（4个季度之和） |
| 累计EPS可以直接用 | 需要转换为单季度后再求TTM |
| 加权和摊薄一样 | 主流平台用摊薄，差异约5-10% |
| 时间范围不影响统计值 | 不同时间范围统计结果不同 |
| diff()可以跨年度计算累计EPS | Q1新年度会重置，diff得到负值 |
| 前复权和不复权一样 | 复权方式影响股价，进而影响PE |

---

## 七、数据选择规则

| 决策点 | 推荐 | 原因 |
|--------|------|------|
| EPS类型 | 摊薄每股收益 | 与主流平台一致 |
| 股价复权 | 不复权 | 使用实际交易价格 |
| 时间范围 | 7-10年 | 代表性较好，覆盖完整周期 |
| EPS频率 | 季度数据 | 匹配财报发布周期 |

---

## 八、验证方法

与主流平台对比验证：

```
同花顺: 市盈率(动) = TTM PE
东方财富: PE-TTM
雪球: TTM市盈率

验证公式:
平台EPS = 平台股价 ÷ 平台PE
我们的EPS ≈ 平台EPS → 正确 ✅
```

---

## 九、Python代码关键逻辑

```python
# 1. 识别季度
result['季度'] = 日期.dt.month.map({3: 'Q1', 6: 'Q2', 9: 'Q3', 12: 'Q4'})

# 2. 计算单季度EPS
if 季度 == 'Q1':
    单季EPS = 累计EPS
else:
    单季EPS = 本期累计 - 上期累计

# 3. 计算TTM EPS
TTM_EPS = 最近4个单季EPS之和

# 4. 计算PE
PE = 股价 ÷ TTM_EPS
```

---

## 十、实战案例：招商银行

### 数据规格

| 项目 | 值 |
|------|-----|
| 数据来源 | AKShare |
| 股票代码 | 600036.SH |
| 时间范围 | 2016-2026（近10年） |
| EPS类型 | 摊薄每股收益(元) |
| 股价复权 | 不复权 |

### 最终结果

| 指标 | 数值 |
|------|------|
| 最新PE | 6.50 (同花顺6.49，误差0.1%) |
| PE均值 | 8.53 |
| PE中位数 | ~8.3 |
| PE标准差 | 2.19 |
| PE最小值 | 4.66 |
| PE最大值 | 14.43 |
| 低估值区间 | 6.34 (均值-1σ) |
| 高估值区间 | 10.71 (均值+1σ) |

### 数据验证

```
日期: 2026-01-30
收盘价: 38.67
TTM EPS: 5.95
PE = 38.67 ÷ 5.95 = 6.50

同花顺PE = 6.49
差异 = 0.01 (0.1%) ✅
```

---

## 十一、生成文件

| 文件 | 说明 |
|------|------|
| `fetch_cmb_pe_data.py` | 数据获取脚本 |
| `cmb_pe_data.json` | 原始数据和统计指标 |
| `cmb_pe_chart.html` | 交互式图表 |

---

## 十二、参考来源

- [PE-TTM滚动市盈率的计算方法 - 理杏仁](https://www.lixinger.com/wiki/pe-ttm)
- [动态市盈率、静态市盈率、TTM市盈率区别 - 知乎](https://zhuanlan.zhihu.com/p/348799273)
- [同花顺市盈率TTM解析](https://www.55188.com/thread-29146665-1-1.html)
